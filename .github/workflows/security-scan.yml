name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning
      
      - name: Run Trivy vulnerability scanner
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: Upload Trivy results to GitHub Security
        continue-on-error: true
        uses: github/codeql-action/upload-sarif@v3
        if: hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Scan for secrets
        run: |
          echo "ðŸ” Scanning for leaked secrets..."
          echo ""
          
          SECRETS_FOUND=0
          
          # Check for OpenAI API keys
          echo "Checking for OpenAI keys..."
          if git log --all --source --full-history -S "sk-" --oneline 2>/dev/null | head -n 1; then
            echo "âš ï¸  WARNING: Potential OpenAI key pattern found in history!"
            echo "ACTION: Review git history and rotate OpenAI API key if needed"
            SECRETS_FOUND=1
          else
            echo "âœ… No OpenAI key patterns found"
          fi
          echo ""
          
          # Check for GitHub tokens
          echo "Checking for GitHub tokens..."
          if git log --all --source --full-history -S "ghp_" --oneline 2>/dev/null | head -n 1; then
            echo "âš ï¸  WARNING: Potential GitHub token found in history!"
            echo "ACTION: Rotate GitHub token immediately at https://github.com/settings/tokens"
            SECRETS_FOUND=1
          else
            echo "âœ… No GitHub token patterns found"
          fi
          echo ""
          
          # Check for Stripe keys
          echo "Checking for Stripe keys..."
          if git log --all --source --full-history -S "sk_live_" --oneline 2>/dev/null | head -n 1; then
            echo "âš ï¸  WARNING: Potential Stripe key found in history!"
            echo "ACTION: Rotate Stripe key at https://dashboard.stripe.com/apikeys"
            SECRETS_FOUND=1
          elif git log --all --source --full-history -S "sk_test_" --oneline 2>/dev/null | head -n 1; then
            echo "âš ï¸  INFO: Stripe test key pattern found (less critical)"
          else
            echo "âœ… No Stripe key patterns found"
          fi
          echo ""
          
          # Check for Railway tokens
          echo "Checking for Railway tokens..."
          if git log --all --source --full-history -S "railway_" --oneline 2>/dev/null | head -n 1; then
            echo "âš ï¸  WARNING: Potential Railway token found!"
            SECRETS_FOUND=1
          else
            echo "âœ… No Railway token patterns found"
          fi
          echo ""
          
          # Check for AWS keys
          echo "Checking for AWS keys..."
          if git log --all --source --full-history -S "AKIA" --oneline 2>/dev/null | head -n 1; then
            echo "âš ï¸  WARNING: Potential AWS key found!"
            SECRETS_FOUND=1
          else
            echo "âœ… No AWS key patterns found"
          fi
          echo ""
          
          if [ $SECRETS_FOUND -eq 1 ]; then
            echo ""
            echo "ðŸš¨ SECURITY ALERT: Potential secrets detected!"
            echo ""
            echo "Immediate actions:"
            echo "1. Review the warnings above"
            echo "2. Rotate any exposed API keys"
            echo "3. Consider using git-filter-repo to remove secrets from history"
            echo "4. Enable secret scanning in GitHub repository settings"
            echo ""
          else
            echo "âœ… Secret scan completed - no obvious patterns found"
          fi
      
      - name: Check for sensitive files
        run: |
          echo "ðŸ“ Checking for sensitive files..."
          echo ""
          
          ISSUES_FOUND=0
          
          # Check if .env exists
          if [ -f ".env" ]; then
            echo "âŒ ERROR: .env file found in repository!"
            echo "This file should NEVER be committed"
            ISSUES_FOUND=1
          else
            echo "âœ… No .env file in repo"
          fi
          
          # Check .gitignore
          if [ -f ".gitignore" ]; then
            if grep -q "^\.env$" .gitignore || grep -q "^.env$" .gitignore; then
              echo "âœ… .env is in .gitignore"
            else
              echo "âš ï¸  WARNING: .env not explicitly in .gitignore"
              ISSUES_FOUND=1
            fi
          else
            echo "âš ï¸  WARNING: No .gitignore file found"
            ISSUES_FOUND=1
          fi
          
          # Check for other sensitive patterns
          if find . -name "*.pem" -o -name "*.key" -o -name "*_rsa" 2>/dev/null | grep -v node_modules | grep -v .git; then
            echo "âš ï¸  WARNING: Potential private key files found"
            ISSUES_FOUND=1
          fi
          
          echo ""
          if [ $ISSUES_FOUND -eq 0 ]; then
            echo "âœ… File sensitivity check passed"
          else
            echo "âš ï¸  File sensitivity issues detected - review recommended"
          fi
      
      - name: Dependency audit
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Running dependency audit..."
          echo ""
          
          if [ -f "package.json" ]; then
            echo "Running npm audit..."
            npm audit --audit-level=moderate || echo "âš ï¸  Vulnerabilities found (see details above)"
          else
            echo "No package.json found, skipping npm audit"
          fi
          
          echo ""
          echo "âœ… Dependency audit completed"
      
      - name: Check repository security settings
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ”’ Checking repository security settings..."
          echo ""
          
          # Get repository info
          REPO_INFO=$(gh api repos/${{ github.repository }} 2>/dev/null || echo '{}')
          
          # Check if repository is public or private
          IS_PRIVATE=$(echo "$REPO_INFO" | jq -r '.private // false')
          
          if [ "$IS_PRIVATE" = "true" ]; then
            echo "âœ… Repository is private"
          else
            echo "âš ï¸  Repository is PUBLIC"
            echo "   Ensure no secrets are committed"
          fi
          
          # Check if security advisories are enabled
          echo ""
          echo "Security features to enable:"
          echo "1. Dependabot alerts: https://github.com/${{ github.repository }}/settings/security_analysis"
          echo "2. Secret scanning: https://github.com/${{ github.repository }}/settings/security_analysis"
          echo "3. Branch protection: https://github.com/${{ github.repository }}/settings/branches"
          echo "4. Two-factor authentication for all collaborators"
      
      - name: Create security report
        if: always()
        run: |
          cat > security-report.md << EOF
          # Security Scan Report
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Repository:** ${{ github.repository }}
          **Branch:** ${{ github.ref_name }}
          **Triggered by:** ${{ github.event_name }}
          **Workflow run:** ${{ github.run_number }}
          
          ## Summary
          
          - âœ… Trivy vulnerability scan completed
          - âœ… Secret pattern scanning completed
          - âœ… Dependency audit completed
          - âœ… File sensitivity check completed
          - âœ… Repository security check completed
          
          ## Recommendations
          
          ### Immediate Actions
          1. ðŸ”‘ Rotate any API keys found in scan warnings
          2. ðŸ”’ Enable branch protection on main branch
          3. ðŸ‘¥ Enable 2FA for all collaborators
          4. ðŸš¨ Enable Dependabot security alerts
          5. ðŸ” Enable secret scanning (if not already enabled)
          
          ### Regular Maintenance
          1. Review and update dependencies monthly
          2. Audit access permissions quarterly
          3. Rotate API keys every 90 days
          4. Monitor security advisories
          5. Keep GitHub Actions up to date
          
          ### Links
          - Security settings: https://github.com/${{ github.repository }}/settings/security_analysis
          - Branch protection: https://github.com/${{ github.repository }}/settings/branches
          - Secrets management: https://github.com/${{ github.repository }}/settings/secrets/actions
          - Dependabot: https://github.com/${{ github.repository }}/security/dependabot
          
          EOF
          
          cat security-report.md
      
      - name: Upload security artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: |
            security-report.md
            trivy-results.sarif
          retention-days: 90
      
      - name: Security summary
        if: always()
        run: |
          echo ""
          echo "âœ… Security scan completed!"
          echo ""
          echo "View full report in artifacts: security-report-${{ github.run_number }}"
          echo ""
