require('dotenv').config();
const https = require('https');

async function getAllIssues() {
  const query = `
    query($first: Int!, $after: String) {
      issues(
        first: $first
        after: $after
        orderBy: createdAt
        filter: {
          team: { id: { eq: "${process.env.LINEAR_TEAM_ID}" } }
        }
      ) {
        pageInfo {
          hasNextPage
          endCursor
        }
        nodes {
          identifier
          title
          createdAt
          state { name }
          priority
          labels { nodes { name } }
        }
      }
    }
  `;

  let allIssues = [];
  let hasNextPage = true;
  let cursor = null;

  while (hasNextPage) {
    const postData = JSON.stringify({
      query: query.replace('$after: String', cursor ? `after: "${cursor}"` : '')
    });

    const options = {
      hostname: 'api.linear.app',
      path: '/graphql',
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': process.env.LINEAR_API_KEY,
        'Content-Length': postData.length
      }
    };

    const result = await new Promise((resolve, reject) => {
      const req = https.request(options, (res) => {
        let data = '';
        res.on('data', (chunk) => data += chunk);
        res.on('end', () => {
          try {
            resolve(JSON.parse(data));
          } catch (e) {
            reject(e);
          }
        });
      });
      req.on('error', reject);
      req.write(postData);
      req.end();
    });

    if (result.data?.issues) {
      allIssues = allIssues.concat(result.data.issues.nodes);
      hasNextPage = result.data.issues.pageInfo.hasNextPage;
      cursor = result.data.issues.pageInfo.endCursor;
    } else {
      break;
    }
  }

  return allIssues;
}

async function main() {
  console.log('\nðŸ“Š All Linear Issues from Planning Agent:\n');
  console.log('='.repeat(70));
  
  const issues = await getAllIssues();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  const todayIssues = issues.filter(i => {
    const created = new Date(i.createdAt);
    created.setHours(0, 0, 0, 0);
    return created.getTime() === today.getTime();
  });

  console.log(`\nðŸ†• Created Today: ${todayIssues.length} issues\n`);

  todayIssues.forEach((issue, idx) => {
    console.log(`${idx + 1}. [${issue.identifier}] ${issue.title}`);
    console.log(`   Priority: ${issue.priority || 'None'}`);
    console.log(`   Status: ${issue.state?.name || 'Unknown'}`);
    if (issue.labels?.nodes?.length > 0) {
      console.log(`   Labels: ${issue.labels.nodes.map(l => l.name).join(', ')}`);
    }
    console.log('');
  });

  console.log('='.repeat(70));
  console.log(`\nðŸ“ˆ Total Issues in Linear: ${issues.length}`);
  console.log(`ðŸ¤– Generated by Planning Agent Today: ${todayIssues.length}\n`);
}

main().catch(console.error);
